<!DOCTYPE html>
<html>
    <head>
        <title></title>
        <link href="style.css" rel="stylesheet" type="text/css">
        <script src="/socket.io/socket.io.js"></script>
        <script src="./dropzone-5.7.0/dist/dropzone.js"></script>
        <script src="jquery-3.5.1.min.js"></script>
        <script src="js.cookie-2.2.1.min.js"></script>
        <script>
            //creates the ID for this user if one doesn't already exist
            function uuidv4() {
              return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
              });
            }
            if(Cookies.get("userID") == undefined)
            {
                Cookies.set("userID", uuidv4())
            }
        </script>
        <!--Insert google analytics here-->
    </head>
    <body onLoad="fixStuff()">
    	<nav class="navBar"></nav>
    	<div style="width: 100%; height: 120vh;">
	    	<h1 class='title'>Free music fingerprinting, right here on the web.</h1>
	    	<div id="mainNavs">
	    	<div onclick='location.href = "#upload"' style="grid-area: a;" id="toUpload" class='mainNavigation'><div><h2>Upload</h2></div></div>
	    	<div style="grid-area: b;" id="toCompare" class='mainNavigation'><div><h2>Compare</h2></div></div>
	    	</div>
    	</div>
        <div id="yourUploads" class='mainSection'>
            <h2>Your files</h2>
            <p id="yourUploadsTxt"></p>
            <script>
                function setupUploads()
                {
                    var uploadsArea = document.getElementById("yourUploadsTxt");
                    var uploads = Cookies.get("comparisons");
                    console.log(uploads);
                    if(!uploads){uploadsArea.innerHTML = "You haven't uploaded any files."; return;}
                    uploads = JSON.parse(uploads);
                    var newTxt = ""
                    for(var i in uploads)
                    {
                        upload = uploads[i]
                        var compared = ""
                        compared = " - Pending"
                        newTxt += upload + compared + "<br>";
                    }
                    uploadsArea.innerHTML = newTxt;
                }
            setupUploads()
            </script>
        </div>
        <br><br><br><br><br><!--I know this is a terrible practice, but i'm lazy--><br><br>
    	<div id="compare" class='mainSection'>
         <h2>Compare a file to our dataset</h2>
         <form name="compareFile" action="/compare/" onsubmit="return VerifyCompare();" method="post" id="compareDropzone" enctype="multipart/form-data">
            <p id='compareError' class='error'></p>
            <label for="file">File: </label>
             <input type="file" id="file" name="file" required>
             <input type="text" id="userID" name="userID">
             <input class="submitButton" type="submit" value="OK">
         </form>   
        </div>
        <br><br><br><br><br><br><br>
        <div id="upload" class='mainSection'>
    		<h2>Upload a file to the database</h2>
    		<form name="uploadFile" action="/upload/" onsubmit="return VerifyForm();" method="post" id="uploadDropzone" enctype="multipart/form-data">
    			<p id='uploadError' class='error'></p>
    			<label for="file">File: </label>
    			<input type='file' id='file' name='file' required>
    			<label for="audio_name">Track Name: </label>
    			<input type="text" id="audio_name" name="audio_name" placeholder="Name of track" required autocomplete="off"></input><br>
    			<!--<label for="artist_name">Artist Name:</label>
    			<input type="text" id="artist_name" name="artist_name" placeholder="Name of artist" required autocomplete="off"></input><br>-->
                <input class="submitButton" type="submit" value="OK">
    		</form>
            <script>
    			const socket = io('ws://localhost:3200');
                function ClearCookies()
                {
                    document.cookie.split(";").forEach(function(c) { document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); });
                }
                function VerifyCompare()
                {
                    document.compareFile.userID.value = Cookies.get("userID");
                    if(!document.compareFile.file.value.toString().endsWith(".wav"))
                    {
                        $("#compareError").html("Please upload a .WAV file. ");
                        return false;
                    }
                    if(!Cookies.get("comparisons")){
                        Cookies.set("comparisons", JSON.stringify([]));
                    }
                    var old = JSON.parse(Cookies.get("comparisons"));
                    old.push(document.compareFile.file.value.toString().replace(/^.*[\\\/]/, ''));
                    Cookies.set("comparisons", JSON.stringify(old));
                    console.log("test");
                    return true;
                }
    			function VerifyForm()
    			{
    				console.log(Cookies.get());
    				if(!document.uploadFile.file.value.toString().endsWith(".wav"))
    				{
    					$("#uploadError").html("Please upload a .WAV file. ");
    					return false;
    				}
    				if(document.uploadFile.audio_name.value.length < 3)
    				{
    					$("#uploadError").html("Name too short");
    					return false;
    				}
    				//set cookie
    				//check if "uploads" cookie exists. If not, create it.
    				if(!Cookies.get("uploads")){
    					Cookies.set("uploads", JSON.stringify([]));
    				}
    				var oldUploads = JSON.parse(Cookies.get("uploads"));
                    console.log(oldUploads);
                    var newUpload = document.uploadFile.file.value.toString().replace(/^.*[\\\/]/, '') + " | \"" + document.uploadFile.audio_name.value + "\"";
    				oldUploads.push(newUpload);
                    Cookies.set("uploads", JSON.stringify(oldUploads));
                    return true;
    			}
    			function fixStuff()
    			{

    			}

    		</script>
    	</div>

    	<script>

    	</script>
	</body>
</html>